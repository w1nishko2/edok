<?php

namespace App\Services;

use App\Models\Recipe;
use App\Models\Category;
use GuzzleHttp\Client;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use DOMDocument;
use DOMXPath;

class RecipeParserService
{
    protected Client $client;
    protected string $baseUrl = 'https://food.ru';

    public function __construct()
    {
        $this->client = new Client([
            'verify' => false,
            'timeout' => 30,
            'headers' => [
                'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Accept' => 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                'Accept-Language' => 'ru-RU,ru;q=0.9,en;q=0.8',
                'Accept-Encoding' => 'gzip, deflate',
            ]
        ]);
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞ –ø–æ URL
     *
     * @param string $url URL —Ä–µ—Ü–µ–ø—Ç–∞
     * @return Recipe|null
     */
    public function parseRecipe(string $url): ?Recipe
    {
        try {
            Log::info("–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ—Ü–µ–ø—Ç–∞: {$url}");

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ä–µ—Ü–µ–ø—Ç
            if (Recipe::where('source_url', $url)->exists()) {
                Log::info("–†–µ—Ü–µ–ø—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {$url}");
                return null;
            }

            $response = $this->client->get($url);
            $html = $response->getBody()->getContents();

            // –ü–æ–¥–∞–≤–ª—è–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
            libxml_use_internal_errors(true);
            
            $dom = new DOMDocument();
            $dom->loadHTML($html);
            $xpath = new DOMXPath($dom);
            
            libxml_clear_errors();

            // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–≥–ª–∞—Å–Ω–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            $title = $this->parseTitle($xpath);
            $description = $this->parseDescription($xpath);
            
            $data = [
                'title' => $title,
                'slug' => $this->generateSlug($title, $url),
                'meta_title' => $this->parseMetaTitle($xpath, $title),
                'meta_description' => $this->parseMetaDescription($xpath, $description),
                'meta_keywords' => $this->parseMetaKeywords($xpath, $title),
                'canonical_url' => $url,
                'description' => $description,
                'image_path' => $this->downloadImage($xpath),
                'og_image' => $this->parseOgImage($xpath),
                'ingredients' => $this->parseIngredients($xpath),
                'steps' => $this->parseSteps($xpath),
                'nutrition' => $this->parseNutrition($xpath),
                'prep_time' => null, // povar.ru –Ω–µ —Ä–∞–∑–¥–µ–ª—è–µ—Ç prep –∏ cook time
                'cook_time' => null,
                'total_time' => $this->parseTotalTime($xpath),
                'servings' => $this->parseServings($xpath),
                'difficulty' => null, // povar.ru –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å
                'rating' => $this->parseRating($xpath),
                'rating_count' => $this->parseRatingCount($xpath),
                'source_url' => $url,
                'views' => 0, // povar.ru –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
                'likes' => 0, // povar.ru –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–∞–π–∫–∏
                'dislikes' => 0, // povar.ru –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∑–ª–∞–π–∫–∏
            ];

            // –°–æ–∑–¥–∞–µ–º —Ä–µ—Ü–µ–ø—Ç
            $recipe = Recipe::create($data);
            
            // –ü–∞—Ä—Å–∏–º –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            $this->attachCategories($recipe, $xpath);
            
            Log::info("–†–µ—Ü–µ–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: {$data['title']}");

            return $recipe;

        } catch (\Exception $e) {
            Log::error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–µ—Ü–µ–ø—Ç–∞ {$url}: " . $e->getMessage());
            return null;
        }
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–∞
     * <h1 class="detailed fn" itemprop="name">–î–æ–º–∞—à–Ω—è—è –ù—É—Ç–µ–ª–ª–∞</h1>
     */
    protected function parseTitle(DOMXPath $xpath): string
    {
        $nodes = $xpath->query('//h1[@class="detailed fn" and @itemprop="name"]');
        if ($nodes && $nodes->length > 0) {
            return trim($nodes->item(0)->textContent);
        }
        
        // –ü–æ–ø—ã—Ç–∫–∞ –±–µ–∑ –∫–ª–∞—Å—Å–∞
        $nodes = $xpath->query('//h1[@itemprop="name"]');
        if ($nodes && $nodes->length > 0) {
            return trim($nodes->item(0)->textContent);
        }
        
        return '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ –æ–ø–∏—Å–∞–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç–∞
     * Povar.ru –Ω–µ –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç —è–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –≤–æ–∑—å–º–µ–º –∏–∑ meta description
     */
    protected function parseDescription(DOMXPath $xpath): ?string
    {
        // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ meta description
        $nodes = $xpath->query('//meta[@name="description"]');
        if ($nodes && $nodes->length > 0) {
            $content = $nodes->item(0)->getAttribute('content');
            if ($content) {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º HTML-—Å—É—â–Ω–æ—Å—Ç–∏ (&quot; -> ")
                return html_entity_decode(trim($content), ENT_QUOTES | ENT_HTML5, 'UTF-8');
            }
        }
        
        return null;
    }

    /**
     * –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
     * <img itemprop="image" alt="..." src="https://img.povar.ru/main/...JPG">
     */
    protected function downloadImage(DOMXPath $xpath): ?string
    {
        try {
            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å itemprop="image"
            $nodes = $xpath->query('//img[@itemprop="image"]');
            if (!$nodes || $nodes->length === 0) {
                return null;
            }
            
            $imageUrl = $nodes->item(0)->getAttribute('src');
            if (!$imageUrl) {
                return null;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º https: –µ—Å–ª–∏ URL –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å //
            if (str_starts_with($imageUrl, '//')) {
                $imageUrl = 'https:' . $imageUrl;
            }

            Log::info("–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {$imageUrl}");

            $response = $this->client->get($imageUrl);
            $imageContent = $response->getBody()->getContents();

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
            $extension = pathinfo(parse_url($imageUrl, PHP_URL_PATH), PATHINFO_EXTENSION);
            $filename = Str::random(40) . '.' . $extension;
            $path = 'recipes/' . $filename;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ public/storage/recipes
            Storage::disk('public')->put($path, $imageContent);

            return $path;

        } catch (\Exception $e) {
            Log::error("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: " . $e->getMessage());
            return null;
        }
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
     * <li itemprop="recipeIngredient" class="ingredient">
     *   <span class="name">–§—É–Ω–¥—É–∫</span> - 
     *   <span class="value">100</span>
     *   <span class="type"> –≥—Ä.</span>
     * </li>
     */
    protected function parseIngredients(DOMXPath $xpath): array
    {
        $ingredients = [];

        try {
            $nodes = $xpath->query('//li[@itemprop="recipeIngredient"]');
            
            if ($nodes && $nodes->length > 0) {
                foreach ($nodes as $node) {
                    $name = '';
                    $quantity = '';
                    $measure = '';
                    
                    // –ò—â–µ–º span —Å –∫–ª–∞—Å—Å–æ–º "name"
                    $nameNodes = $xpath->query('.//span[@class="name"]', $node);
                    if ($nameNodes && $nameNodes->length > 0) {
                        $name = trim($nameNodes->item(0)->textContent);
                    }
                    
                    // –ò—â–µ–º span —Å –∫–ª–∞—Å—Å–æ–º "value"
                    $valueNodes = $xpath->query('.//span[@class="value"]', $node);
                    if ($valueNodes && $valueNodes->length > 0) {
                        $quantity = trim($valueNodes->item(0)->textContent);
                    }
                    
                    // –ò—â–µ–º span —Å –∫–ª–∞—Å—Å–æ–º "type"
                    $typeNodes = $xpath->query('.//span[@class="type"]', $node);
                    if ($typeNodes && $typeNodes->length > 0) {
                        $measure = trim($typeNodes->item(0)->textContent);
                    }
                    
                    if ($name) {
                        $ingredients[] = [
                            'name' => $name,
                            'quantity' => $quantity,
                            'measure' => $measure
                        ];
                    }
                }
            }
        } catch (\Exception $e) {
            Log::error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: " . $e->getMessage());
        }

        return $ingredients;
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ —à–∞–≥–æ–≤ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
     * <div class="instruction " itemscope itemtype="https://schema.org/HowToStep">
     *   <div class="step-number" data-pseudo-text-before="–®–∞–≥ 1"></div>
     *   <div class="detailed_step_photo_big">
     *     <img src="...">
     *   </div>
     *   <div class="detailed_step_description_big">–¢–µ–∫—Å—Ç —à–∞–≥–∞...</div>
     * </div>
     */
    protected function parseSteps(DOMXPath $xpath): array
    {
        $steps = [];

        try {
            // –ò—â–µ–º div —Å –∫–ª–∞—Å—Å–æ–º instruction (—Å –ø—Ä–æ–±–µ–ª–æ–º –∏–ª–∏ –±–µ–∑)
            $nodes = $xpath->query('//div[contains(@class, "instruction")][@itemtype="https://schema.org/HowToStep"]');
            
            if ($nodes && $nodes->length > 0) {
                $stepNumber = 1;
                foreach ($nodes as $node) {
                    $description = '';
                    $image = null;
                    
                    // –ò—â–µ–º —Ç–µ–∫—Å—Ç —à–∞–≥–∞ –≤ div.detailed_step_description_big
                    $textNodes = $xpath->query('.//div[contains(@class, "detailed_step_description_big")]', $node);
                    if ($textNodes && $textNodes->length > 0) {
                        $description = trim($textNodes->item(0)->textContent);
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º p[@itemprop="text"] (—Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
                    if (!$description) {
                        $textNodes = $xpath->query('.//p[@itemprop="text"]', $node);
                        if ($textNodes && $textNodes->length > 0) {
                            $description = trim($textNodes->item(0)->textContent);
                        }
                    }
                    
                    // –ò—â–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∞–≥–∞
                    $imgNodes = $xpath->query('.//img', $node);
                    if ($imgNodes && $imgNodes->length > 0) {
                        $imageSrc = $imgNodes->item(0)->getAttribute('src');
                        if ($imageSrc) {
                            if (str_starts_with($imageSrc, '//')) {
                                $image = 'https:' . $imageSrc;
                            } elseif (str_starts_with($imageSrc, 'http')) {
                                $image = $imageSrc;
                            } else {
                                $image = $this->baseUrl . $imageSrc;
                            }
                        }
                    }
                    
                    if ($description) {
                        $steps[] = [
                            'step_number' => $stepNumber,
                            'description' => $description,
                            'image' => $image
                        ];
                        $stepNumber++;
                    }
                }
            }
        } catch (\Exception $e) {
            Log::error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —à–∞–≥–æ–≤: " . $e->getMessage());
        }

        return $steps;
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
     * Povar.ru –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ
     */
    protected function parseNutrition(DOMXPath $xpath): array
    {
        $nutrition = [
            'calories' => '0',
            'proteins' => '0',
            'fats' => '0',
            'carbs' => '0',
            'proteins_percent' => '0',
            'fats_percent' => '0',
            'carbs_percent' => '0',
        ];

        return $nutrition;
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
     * <meta itemprop="totalTime" content="PT20M">
     * <span class="value-title">20 –º–∏–Ω</span>
     */
    protected function parseTotalTime(DOMXPath $xpath): ?int
    {
        // –ò—â–µ–º meta itemprop="totalTime"
        $nodes = $xpath->query('//meta[@itemprop="totalTime"]');
        if ($nodes && $nodes->length > 0) {
            $content = $nodes->item(0)->getAttribute('content');
            if ($content) {
                return $this->parseIsoDuration($content);
            }
        }
        
        return null;
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ ISO 8601 duration –≤ –º–∏–Ω—É—Ç—ã
     * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—ã: PT2H, PT30M, PT1H30M, PT90M
     */
    protected function parseIsoDuration(string $duration): ?int
    {
        if (!preg_match('/^PT/', $duration)) {
            return null;
        }

        $totalMinutes = 0;

        // –ü–∞—Ä—Å–∏–º —á–∞—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, PT2H –∏–ª–∏ PT1H30M)
        if (preg_match('/(\d+)H/', $duration, $matches)) {
            $totalMinutes += (int) $matches[1] * 60;
        }

        // –ü–∞—Ä—Å–∏–º –º–∏–Ω—É—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, PT30M –∏–ª–∏ PT1H30M)
        if (preg_match('/(\d+)M/', $duration, $matches)) {
            $totalMinutes += (int) $matches[1];
        }

        return $totalMinutes > 0 ? $totalMinutes : null;
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Ä—Ü–∏–π
     * <span itemprop="recipeYield" class="yield value">6</span>
     */
    protected function parseServings(DOMXPath $xpath): ?int
    {
        $nodes = $xpath->query('//span[@itemprop="recipeYield"]');
        if ($nodes && $nodes->length > 0) {
            $text = trim($nodes->item(0)->textContent);
            if (preg_match('/(\d+)/', $text, $matches)) {
                return (int) $matches[1];
            }
        }
        
        return null;
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–π—Ç–∏–Ω–≥–∞
     * <span itemprop="ratingValue">5.0</span>
     */
    protected function parseRating(DOMXPath $xpath): float
    {
        $nodes = $xpath->query('//span[@itemprop="ratingValue"]');
        if ($nodes && $nodes->length > 0) {
            $rating = (float) trim($nodes->item(0)->textContent);
            return min(5.0, max(0.0, $rating));
        }
        
        return 0.0;
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ü–µ–Ω–æ–∫
     * <span itemprop="ratingCount">234</span>
     */
    protected function parseRatingCount(DOMXPath $xpath): int
    {
        $nodes = $xpath->query('//span[@itemprop="ratingCount"]');
        if ($nodes && $nodes->length > 0) {
            return (int) trim($nodes->item(0)->textContent);
        }
        
        return 0;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è slug –∏–∑ URL
     * URL —Ñ–æ—Ä–º–∞—Ç: /recipes/salat_parij-73708.html
     */
    protected function generateSlug(string $title, string $url): string
    {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º slug –∏–∑ URL
        if (preg_match('/\/recipes\/(.+)\.html/', $url, $matches)) {
            return $matches[1];
        }
        
        // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, —Å–æ–∑–¥–∞–µ–º –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
        return Str::slug($title);
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ meta title
     */
    protected function parseMetaTitle(DOMXPath $xpath, string $defaultTitle): ?string
    {
        // –ò—â–µ–º meta property="og:title"
        $nodes = $xpath->query('//meta[@property="og:title"]');
        if ($nodes && $nodes->length > 0) {
            return trim($nodes->item(0)->getAttribute('content'));
        }
        
        // –ò—â–µ–º —Ç–µ–≥ <title>
        $nodes = $xpath->query('//title');
        if ($nodes && $nodes->length > 0) {
            return trim($nodes->item(0)->textContent);
        }
        
        return $defaultTitle . ' - –†–µ—Ü–µ–ø—Ç –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —Å —Ñ–æ—Ç–æ';
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ meta description
     */
    protected function parseMetaDescription(DOMXPath $xpath, ?string $defaultDescription): ?string
    {
        // –ò—â–µ–º meta name="description"
        $nodes = $xpath->query('//meta[@name="description"]');
        if ($nodes && $nodes->length > 0) {
            return trim($nodes->item(0)->getAttribute('content'));
        }
        
        // –ò—â–µ–º meta property="og:description"
        $nodes = $xpath->query('//meta[@property="og:description"]');
        if ($nodes && $nodes->length > 0) {
            return trim($nodes->item(0)->getAttribute('content'));
        }
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ, –æ–±—Ä–µ–∑–∞–µ–º –¥–æ 160 —Å–∏–º–≤–æ–ª–æ–≤
        if ($defaultDescription) {
            return mb_substr($defaultDescription, 0, 160);
        }
        
        return null;
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ meta keywords
     */
    protected function parseMetaKeywords(DOMXPath $xpath, string $title): ?string
    {
        // –ò—â–µ–º meta name="keywords"
        $nodes = $xpath->query('//meta[@name="keywords"]');
        if ($nodes && $nodes->length > 0) {
            return trim($nodes->item(0)->getAttribute('content'));
        }
        
        // –ò—â–µ–º itemprop="keywords"
        $nodes = $xpath->query('//span[@itemprop="keywords"]');
        if ($nodes && $nodes->length > 0) {
            $keywords = [];
            foreach ($nodes as $node) {
                $keywords[] = trim($node->textContent);
            }
            return implode(', ', $keywords);
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
        return $title . ', —Ä–µ—Ü–µ–ø—Ç, –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ, —Å —Ñ–æ—Ç–æ';
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ Open Graph –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
     */
    protected function parseOgImage(DOMXPath $xpath): ?string
    {
        $nodes = $xpath->query('//meta[@property="og:image"]');
        if ($nodes && $nodes->length > 0) {
            return trim($nodes->item(0)->getAttribute('content'));
        }
        
        return null;
    }

    /**
     * –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
     * <span itemprop="recipeCategory">–î–µ—Å–µ—Ä—Ç—ã</span>
     */
    protected function parseCategories(DOMXPath $xpath): array
    {
        $categories = [];
        
        try {
            // –ò—â–µ–º span itemprop="recipeCategory"
            $nodes = $xpath->query('//span[@itemprop="recipeCategory"]');
            
            if ($nodes && $nodes->length > 0) {
                $position = 0;
                foreach ($nodes as $node) {
                    $name = trim($node->textContent);
                    if ($name) {
                        $categories[] = [
                            'name' => $name,
                            'position' => $position++,
                        ];
                    }
                }
            }
            
            if (!empty($categories)) {
                Log::info("‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: " . count($categories) . " - " . implode(', ', array_column($categories, 'name')));
            }
            
        } catch (\Exception $e) {
            Log::error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: " . $e->getMessage());
        }
        
        return $categories;
    }

    /**
     * –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫ —Ä–µ—Ü–µ–ø—Ç—É
     */
    protected function attachCategories(Recipe $recipe, DOMXPath $xpath): void
    {
        try {
            $parsedCategories = $this->parseCategories($xpath);
            
            if (empty($parsedCategories)) {
                Log::warning("‚ö†Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —Ä–µ—Ü–µ–ø—Ç–∞: {$recipe->title}");
                return;
            }

            Log::info("üè∑Ô∏è –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫ —Ä–µ—Ü–µ–ø—Ç—É: {$recipe->title}");

            $categoryIds = [];

            foreach ($parsedCategories as $categoryData) {
                // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                $category = Category::firstOrCreate(
                    ['name' => $categoryData['name']],
                    [
                        'slug' => Str::slug($categoryData['name']),
                        'parent_id' => null,
                    ]
                );

                $categoryIds[] = $category->id;
                
                Log::info("üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è '{$category->name}' (ID: {$category->id})");
            }

            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫ —Ä–µ—Ü–µ–ø—Ç—É
            if (!empty($categoryIds)) {
                $recipe->categories()->sync($categoryIds);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                foreach ($categoryIds as $categoryId) {
                    $category = Category::find($categoryId);
                    if ($category) {
                        $category->recipe_count = $category->recipes()->count();
                        $category->save();
                    }
                }
                
                Log::info("‚úÖ –ö —Ä–µ—Ü–µ–ø—Ç—É '{$recipe->title}' –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: " . count($categoryIds));
            }
        } catch (\Exception $e) {
            Log::error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫ —Ä–µ—Ü–µ–ø—Ç—É {$recipe->title}: " . $e->getMessage());
        }
    }
}
